
syntax = "proto3";
package cacti.satp.v02.crash;

import "google/protobuf/empty.proto";

service CrashRecovery   {
  // util RPCs

  // step RPCs
  rpc RecoverV2Message(RecoverMessage) returns (RecoverUpdateMessage);
  rpc RecoverV2SuccessMessage(RecoverSuccessMessage) returns (RecoverSuccessMessageResponse);
  rpc RollbackV2Message(RollbackMessage) returns (RollbackAckMessage);
}

message RecoverMessage {
  string session_id = 1;
  string message_type = 2;
  string satp_phase = 3;
  int32 sequence_number = 4;
  bool is_backup = 5;
  string new_identity_public_key = 6;
  int64 last_entry_timestamp = 7;
  string client_signature = 8;
}

message RecoverUpdateMessage {
  string session_id = 1;
  string message_type = 2;
  string hash_recover_message = 3;
  repeated persistLogEntry recovered_logs = 4;
  string server_signature = 5;
}

message RecoverSuccessMessage {
  string session_id = 1;
  string message_type = 2;
  string hash_recover_update_message = 3;
  bool success = 4;
  repeated string entries_changed = 5;
  string client_signature = 6;
}

message RecoverSuccessMessageResponse {
  string session_id = 1;
  bool received = 2;
  string server_signature = 3;
}

message RollbackMessage {
  string session_id = 1;
  string message_type = 2;
  bool success = 3;
  repeated string actions_performed = 4;
  repeated string proofs = 5;
  string client_signature = 6;
}

message RollbackAckMessage {
  string session_id = 1;
  string message_type = 2;
  bool success = 3;
  repeated string actions_performed = 4;
  repeated string proofs = 5;
  string server_signature = 6;
}

message persistLogEntry {
  string session_id = 1;
  string type = 2;
  string key = 3;
  string operation = 4;
  string timestamp = 5;
  string data = 6;
  int32 sequence_number = 7;
}

message RollbackLogEntry {
  string session_id = 1;
  string stage = 2;
  string timestamp = 3;
  string action = 4; // action performed during rollback
  string status = 5; 
  string details = 6;
}

message RollbackState {
  string session_id = 1;
  string current_stage = 2;
  repeated RollbackLogEntry rollback_log_entries = 3;
  string status = 4; // Overall status (e.g., IN_PROGRESS, COMPLETED, FAILED)
  string details = 5;
}
