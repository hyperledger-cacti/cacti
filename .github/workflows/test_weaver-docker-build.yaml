# Copyright IBM Corp. All Rights Reserved.
#
# SPDX-License-Identifier: CC-BY-4.0

name: Test All Docker Images Build

env:
  NODEJS_VERSION: v18.18.2

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build_docker_relay:
    # if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3.5.2

      - uses: dorny/paths-filter@v2.11.1
        id: changes
        with:
          filters: |
            weaver_code_changed:
              - './weaver/common/protos-rs/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/core/relay/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - '.github/workflows/test_weaver-docker-build.yaml'

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Image
        run: make build-server-local
        working-directory: weaver/core/relay

  build_docker_fabric_driver_local:
    # if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3.5.2

      - uses: dorny/paths-filter@v2.11.1
        id: changes
        with:
          filters: |
            weaver_code_changed:
              - './weaver/common/protos/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/common/protos-js/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/sdks/fabric/interoperation-node-sdk/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/weaver/core/drivers/fabric-driver/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - '.github/workflows/test_weaver-docker-build.yaml'

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Use Node.js ${{ env.NODEJS_VERSION }}
        uses: actions/setup-node@v3.6.0
        with:
          node-version: ${{ env.NODEJS_VERSION }}

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Use Protoc 3.15
        run: |
          curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v3.15.6/protoc-3.15.6-linux-x86_64.zip
          unzip protoc-3.15.6-linux-x86_64.zip -d protoc

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build JS Protos (Local)
        run: |
          export PATH="$PATH:${GITHUB_WORKSPACE}/protoc/bin"
          make build
        working-directory: weaver/common/protos-js

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Fabric Interop Node SDK (Local)
        run: make build-local
        working-directory: weaver/sdks/fabric/interoperation-node-sdk

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Image (Local)
        run: make build-image-local
        working-directory: weaver/core/drivers/fabric-driver

  build_docker_fabric_driver_packages:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3.5.2

      - uses: dorny/paths-filter@v2.11.1
        id: changes
        with:
          filters: |
            weaver_code_changed:
              - './weaver/weaver/core/drivers/fabric-driver/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - '.github/workflows/test_weaver-docker-build.yaml'

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Setup .npmrc
        run: |
          cp .npmrc.template .npmrc
          sed -i "s/<personal-access-token>/${{ secrets.GITHUB_TOKEN }}/g" .npmrc
          cat .npmrc
        working-directory: weaver/core/drivers/fabric-driver

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Image
        run: make build-image
        working-directory: weaver/core/drivers/fabric-driver

  build_docker_corda_driver_local:
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3.5.2

      - uses: dorny/paths-filter@v2.11.1
        id: changes
        with:
          filters: |
            weaver_code_changed:
              - './weaver/common/protos/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/common/protos-java-kt/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/core/network/corda-interop-app/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/sdks/corda/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/core/drivers/corda-driver/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - '.github/workflows/test_weaver-docker-build.yaml'

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Set up JDK 8
        uses: actions/setup-java@v3.11.0
        with:
          java-version: '8'
          distribution: 'adopt'

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Protos (Local)
        run: make build
        working-directory: weaver/common/protos-java-kt

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Corda Interop App (Local)
        run: make build-local
        working-directory: weaver/core/network/corda-interop-app

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Corda Interop SDK (Local)
        run: make build
        working-directory: weaver/sdks/corda

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Image (Local)
        run: make image-local
        working-directory: weaver/core/drivers/corda-driver

  build_docker_corda_driver_packages:
    if: ${{ false }}
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3.5.2

      - uses: dorny/paths-filter@v2.11.1
        id: changes
        with:
          filters: |
            weaver_code_changed:
              - './weaver/core/drivers/corda-driver/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - '.github/workflows/test_weaver-docker-build.yaml'

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Generate github.properties
        run: |
          echo "Using ${GITHUB_ACTOR} user."
          echo "username=${GITHUB_ACTOR}" >> github.properties
          echo "password=${{ secrets.GITHUB_TOKEN }}" >> github.properties
          echo "url=https://maven.pkg.github.com/${GITHUB_ACTOR}/cacti" >> github.properties

          echo "Using ${GITHUB_ACTOR} user."
          echo "username=${GITHUB_ACTOR}" >> github.main.properties
          echo "password=${{ secrets.GITHUB_TOKEN }}" >> github.main.properties
          echo "url=https://maven.pkg.github.com/hyperledger/cacti" >> github.main.properties

          make build || mv github.main.properties github.properties
          make clean

          cat github.properties
        working-directory: weaver/core/drivers/corda-driver

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Image
        run: make image
        working-directory: weaver/core/drivers/corda-driver

  build_docker_iin_agent_local:
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3.5.2

      - uses: dorny/paths-filter@v2.11.1
        id: changes
        with:
          filters: |
            weaver_code_changed:
              - './weaver/common/protos/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/common/protos-js/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/sdks/fabric/interoperation-node-sdk/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - './weaver/core/identity-management/iin-agent/**!(*.md|*.css|*.html|*.jpg|*.jpeg|*.png)'
              - '.github/workflows/test_weaver-docker-build.yaml'

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Use Node.js ${{ env.NODEJS_VERSION }}
        uses: actions/setup-node@v3.6.0
        with:
          node-version: ${{ env.NODEJS_VERSION }}

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Use Protoc 3.15
        run: |
          curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v3.15.6/protoc-3.15.6-linux-x86_64.zip
          unzip protoc-3.15.6-linux-x86_64.zip -d protoc

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build JS Protos (Local)
        run: |
          export PATH="$PATH:${GITHUB_WORKSPACE}/protoc/bin"
          make build
        working-directory: weaver/common/protos-js

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Fabric Interop Node SDK (Local)
        run: make build-local
        working-directory: weaver/sdks/fabric/interoperation-node-sdk

      - if: steps.changes.outputs.weaver_code_changed == 'true'
        name: Build Image
        run: make build-image-local
        working-directory: weaver/core/identity-management/iin-agent
