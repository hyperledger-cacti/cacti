name: trivy-container-image-scan




on:

  push:

  pull_request:

    # Publish `main` as Docker `latest` image.

    branches:

      - main




    # Publish `v1.2.3` tags as releases.

    tags:

      - v*





jobs:




  build:

    name: Scan cactus-example-carbon-accounting table image

    runs-on: ubuntu-20.04

    steps:

      - name: Checkout code

        uses: actions/checkout@v2

      - name: Build an image from Dockerfile

        run: |

          DOCKER_BUILDKIT=1 docker build ./ -f ./examples/carbon-accounting/Dockerfile -t cactus-example-carbon-accounting

      - name: Run Trivy vulnerability scanner

        uses: aquasecurity/trivy-action@0.11.2

        with:

          image-ref: 'cactus-example-carbon-accounting'

          format: 'table'

          exit-code: '0'

          ignore-unfixed: true

          vuln-type: 'os,library'

          severity: 'CRITICAL,HIGH'




  build2:

    name: Scan cactus-example-carbon-accounting json image

    runs-on: ubuntu-20.04

    steps:

      - name: Checkout code

        uses: actions/checkout@v2

      - name: Build an image from Dockerfile

        run: |

          DOCKER_BUILDKIT=1 docker build ./ -f ./examples/carbon-accounting/Dockerfile -t cactus-example-carbon-accounting

      - name: Run Trivy vulnerability scanner

        uses: aquasecurity/trivy-action@0.11.2

        with:

          image-ref: 'cactus-example-carbon-accounting'

          format: 'json'

          exit-code: '0'

          ignore-unfixed: true

          vuln-type: 'os,library'

          severity: 'CRITICAL,HIGH'