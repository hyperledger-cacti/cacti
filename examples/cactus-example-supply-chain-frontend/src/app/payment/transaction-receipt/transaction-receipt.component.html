<div class="transaction-receipt dark-theme">
  <!-- Transaction Progress Bar -->
  <div class="progress-bar-container mb-6">
    <mat-card class="dark-card">
      <mat-card-header>
        <mat-card-title class="text-white">Transaction Progress</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <!-- Custom stepper replacement -->
        <div class="custom-stepper">
          <!-- Step 1 -->
          <div class="custom-step">
            <div class="step-header">
              <div
                class="step-icon-container completed"
                style="background-color: #000000 !important"
              >
                <mat-icon>paid</mat-icon>
              </div>
              <div class="step-label">Payment Initiated</div>
            </div>
            <div class="step-content">
              <p>Transaction submitted to blockchain</p>
            </div>
          </div>

          <!-- Step 2 -->
          <div class="custom-step">
            <div class="step-header">
              <div
                class="step-icon-container"
                [ngClass]="{ completed: transaction?.status === true }"
                style="background-color: #000000 !important"
              >
                <mat-icon>verified</mat-icon>
              </div>
              <div class="step-label">Payment Confirmed</div>
            </div>
            <div class="step-content">
              <p>Blockchain transaction validated</p>
            </div>
          </div>

          <!-- Step 3 -->
          <div class="custom-step">
            <div class="step-header">
              <div
                class="step-icon-container"
                [ngClass]="{
                  completed:
                    transaction?.status === true && product?.status === 'SOLD'
                }"
                style="background-color: #000000 !important"
              >
                <mat-icon>swap_horiz</mat-icon>
              </div>
              <div class="step-label">Status Updated</div>
            </div>
            <div class="step-content">
              <p>Product status changed to SOLD</p>
            </div>
          </div>

          <!-- Step 4 -->
          <div class="custom-step">
            <div class="step-header">
              <div
                class="step-icon-container"
                [ngClass]="{
                  completed:
                    transaction?.status === true && product?.status === 'SOLD'
                }"
                style="background-color: #000000 !important"
              >
                <mat-icon>task_alt</mat-icon>
              </div>
              <div class="step-label">Completed</div>
            </div>
            <div class="step-content">
              <p>Transaction complete</p>
            </div>
          </div>
        </div>

        <!-- Current Status Summary -->
        <div
          class="status-summary mt-4 p-3 rounded-lg bg-gray-800 border border-gray-700"
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center">
              <mat-icon class="mr-2 text-blue-400">
                {{
                  !transaction?.status && isLoading
                    ? "hourglass_empty"
                    : transaction?.status === true &&
                        (product?.status === "SOLD" ||
                          product?.status === "SHIPPED")
                      ? "check_circle"
                      : transaction?.status === true &&
                          product?.status !== "SOLD" &&
                          product?.status !== "SHIPPED"
                        ? "warning"
                        : "error"
                }}
              </mat-icon>
              <span class="text-white">
                {{
                  !transaction?.status && isLoading
                    ? "Transaction in progress..."
                    : transaction?.status === true &&
                        (product?.status === "SOLD" ||
                          product?.status === "SHIPPED")
                      ? "Purchase completed successfully!"
                      : transaction?.status === true &&
                          product?.status !== "SOLD" &&
                          product?.status !== "SHIPPED"
                        ? "Payment confirmed, product status pending update"
                        : "Transaction failed"
                }}
              </span>
            </div>

            <!-- Refresh button for product status -->
            <div class="flex items-center">
              <button
                *ngIf="
                  transaction?.status === true &&
                  product &&
                  product.status !== 'SOLD' &&
                  product.status !== 'SHIPPED'
                "
                mat-icon-button
                matTooltip="Refresh product status"
                (click)="refreshProductData()"
                class="text-blue-400 mr-2"
              >
                <mat-icon>refresh</mat-icon>
              </button>

              <!-- For bamboo and bookshelf products - direct update button -->
              <button
                *ngIf="
                  transaction?.status === true &&
                  productType &&
                  [
                    'bamboo',
                    'bambooharvest',
                    'bamboo-harvest',
                    'bookshelf'
                  ].includes(productType.toLowerCase()) &&
                  ((product && product.status !== 'SOLD') || !product)
                "
                mat-raised-button
                color="accent"
                matTooltip="Update status directly without blockchain call"
                (click)="directUpdateProductStatus(productType === 'bamboo')"
                class="text-white text-sm mr-2"
              >
                <mat-icon class="mr-1">update</mat-icon>
                Direct Update
              </button>

              <!-- Force status update button -->
              <button
                *ngIf="
                  transaction?.status === true &&
                  ((product &&
                    product.status !== 'SOLD' &&
                    product.status !== 'SHIPPED') ||
                    !product)
                "
                mat-raised-button
                color="accent"
                matTooltip="Force update product status"
                (click)="forceStatusUpdate()"
                class="text-white text-sm"
              >
                <mat-icon class="mr-1">update</mat-icon>
                Force Status Update
              </button>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="isLoading" class="flex justify-center items-center p-10">
    <mat-spinner diameter="40"></mat-spinner>
    <span class="ml-4">Loading transaction details...</span>
  </div>

  <div
    *ngIf="!isLoading && error && !error.includes('gas')"
    class="text-center py-4 px-4 mb-4"
  >
    <mat-icon class="text-red-500 text-4xl mb-2">error_outline</mat-icon>
    <p class="text-lg mb-2">{{ error }}</p>
    <p class="text-gray-600 mb-4">
      You can still view the transaction on Etherscan below.
    </p>
    <button mat-raised-button color="primary" (click)="retryFetch()">
      <mat-icon>refresh</mat-icon> Retry
    </button>
  </div>

  <div
    *ngIf="!error || error.includes('gas')"
    class="text-center py-4 px-4 mb-4 success-message"
  >
    <mat-icon class="text-green-500 text-4xl mb-2">check_circle</mat-icon>
    <p class="text-lg mb-2">Transaction submitted successfully!</p>
    <p class="text-gray-600 mb-4">
      The transaction is being processed on the blockchain.
    </p>
  </div>

  <!-- Display transaction data with proper fallbacks -->
  <div class="container p-4">
    <mat-card class="mb-6">
      <mat-card-header>
        <mat-card-title>Transaction Receipt</mat-card-title>
        <mat-card-subtitle>
          <a
            [href]="getEtherscanLink()"
            target="_blank"
            class="text-blue-500 hover:underline flex items-center"
          >
            View on Etherscan
            <mat-icon class="text-sm ml-1">open_in_new</mat-icon>
          </a>
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content class="mt-4">
        <div
          *ngIf="apiKeyMessage"
          class="mb-6 p-4 bg-amber-50 rounded-lg border border-amber-200"
        >
          <p class="text-amber-800">
            <mat-icon class="align-middle mr-2 text-amber-500">info</mat-icon>
            <span class="align-middle">
              {{ apiKeyMessage }}
            </span>
          </p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Always show the transaction hash -->
          <div class="field-container">
            <div class="field-label">Transaction Hash</div>
            <div class="field-value-with-copy">
              <span class="field-value hash-value">{{ txHash }}</span>
              <button
                mat-icon-button
                (click)="copyToClipboard(txHash, 'Transaction hash')"
                class="copy-button"
                matTooltip="Copy to clipboard"
                style="
                  display: inline-flex !important;
                  align-items: center !important;
                  justify-content: center !important;
                "
              >
                <mat-icon style="margin-right: 0 !important"
                  >content_copy</mat-icon
                >
                <span class="sr-only">Copy</span>
              </button>
            </div>
          </div>

          <div class="field-container">
            <div class="field-label">Status</div>
            <div class="field-value">
              <span
                class="status-indicator"
                [ngClass]="{
                  'text-green-600': transaction?.status,
                  'text-orange-600': !transaction?.blockNumber || !transaction,
                  'text-red-600':
                    transaction?.blockNumber && transaction?.status === false
                }"
              >
                <mat-icon *ngIf="transaction?.status" class="text-green-600"
                  >check_circle</mat-icon
                >
                <mat-icon
                  *ngIf="
                    transaction?.blockNumber && transaction?.status === false
                  "
                  class="text-red-600"
                  >error</mat-icon
                >
                <mat-icon
                  *ngIf="!transaction?.blockNumber || !transaction"
                  class="text-orange-600"
                  >hourglass_empty</mat-icon
                >
                {{
                  transaction?.status
                    ? "Success"
                    : transaction?.blockNumber
                      ? "Failed"
                      : "Pending"
                }}
              </span>
            </div>
          </div>

          <!-- Product Information Section when available -->
          <div class="field-container" *ngIf="product">
            <div class="field-label">Product ID</div>
            <div class="field-value">{{ product.id }}</div>
          </div>

          <div class="field-container" *ngIf="product">
            <div class="field-label">Product Status</div>
            <div class="field-value">
              <span
                [ngClass]="{
                  'text-green-600': product.status === 'SOLD',
                  'text-orange-600': product.status === 'AVAILABLE',
                  'text-blue-600':
                    product.status === 'PROCESSING' ||
                    product.status === 'SHIPPED',
                  'text-gray-600': !product.status
                }"
              >
                {{ product.status || "Unknown" }}
              </span>
            </div>
          </div>

          <div class="field-container">
            <div class="field-label">Block</div>
            <div class="field-value">
              <ng-container *ngIf="!transaction?.blockNumber">
                <span class="text-orange-600">Pending</span>
              </ng-container>
              <ng-container *ngIf="transaction?.blockNumber">
                <a
                  [href]="getEtherscanBlockLink(transaction.blockNumber)"
                  target="_blank"
                  class="text-blue-500 hover:underline"
                >
                  {{ transaction.blockNumber }}
                </a>
              </ng-container>
            </div>
          </div>

          <div class="field-container">
            <div class="field-label">Timestamp</div>
            <div class="field-value">
              {{
                transaction?.timestamp
                  ? (transaction.timestamp * 1000 | date: "medium")
                  : "Pending"
              }}
            </div>
          </div>

          <div class="field-container">
            <div class="field-label">From</div>
            <div class="field-value-with-copy">
              <ng-container *ngIf="!transaction?.from">
                <span class="text-orange-600">Pending</span>
              </ng-container>
              <ng-container *ngIf="transaction?.from">
                <a
                  [href]="getEtherscanAddressLink(transaction.from)"
                  target="_blank"
                  class="text-blue-500 hover:underline"
                >
                  {{ formatAddress(transaction.from) }}
                </a>
                <button
                  mat-icon-button
                  (click)="copyToClipboard(transaction.from, 'From address')"
                  class="copy-button"
                  matTooltip="Copy to clipboard"
                  style="
                    display: inline-flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                  "
                >
                  <mat-icon style="margin-right: 0 !important"
                    >content_copy</mat-icon
                  >
                  <span class="sr-only">Copy</span>
                </button>
              </ng-container>
            </div>
          </div>

          <div class="field-container">
            <div class="field-label">To</div>
            <div class="field-value-with-copy">
              <ng-container *ngIf="!transaction?.to">
                <span class="text-orange-600">Pending</span>
              </ng-container>
              <ng-container *ngIf="transaction?.to">
                <a
                  [href]="getEtherscanAddressLink(transaction.to)"
                  target="_blank"
                  class="text-blue-500 hover:underline"
                >
                  {{ formatAddress(transaction.to) }}
                </a>
                <button
                  mat-icon-button
                  (click)="copyToClipboard(transaction.to, 'To address')"
                  class="copy-button"
                  matTooltip="Copy to clipboard"
                  style="
                    display: inline-flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                  "
                >
                  <mat-icon style="margin-right: 0 !important"
                    >content_copy</mat-icon
                  >
                  <span class="sr-only">Copy</span>
                </button>
              </ng-container>
            </div>
          </div>

          <div class="field-container">
            <div class="field-label">Value</div>
            <div class="field-value">
              <ng-container *ngIf="!transaction?.value">
                <span class="text-orange-600">Pending</span>
              </ng-container>
              <ng-container *ngIf="transaction?.value">
                <span class="font-bold">{{
                  formatEther(transaction.value)
                }}</span>
              </ng-container>
            </div>
          </div>

          <!-- Only show gas used if available -->
          <div class="field-container" *ngIf="transaction?.gasUsed">
            <div class="field-label">Gas Used</div>
            <div class="field-value">{{ transaction.gasUsed }}</div>
          </div>

          <!-- Only show gas price if available -->
          <div class="field-container" *ngIf="transaction?.gasPrice">
            <div class="field-label">Gas Price</div>
            <div class="field-value">
              {{ formatGwei(transaction.gasPrice) }}
            </div>
          </div>

          <!-- Only show nonce if available, avoid the nonce error -->
          <div
            class="field-container"
            *ngIf="
              transaction?.nonce !== undefined && transaction?.nonce !== null
            "
          >
            <div class="field-label">Nonce</div>
            <div class="field-value">{{ transaction.nonce }}</div>
          </div>
        </div>

        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <p class="text-blue-800">
            <mat-icon class="align-middle mr-2 text-blue-500"
              >open_in_new</mat-icon
            >
            <span class="align-middle">
              <a
                [href]="getEtherscanLink()"
                target="_blank"
                class="font-bold text-blue-600 hover:underline"
              >
                Click here to view complete transaction details on Etherscan
              </a>
            </span>
          </p>
        </div>

        <!-- Add a retry button at the bottom too -->
        <div *ngIf="error" class="mt-4 text-center">
          <button mat-raised-button color="primary" (click)="retryFetch()">
            <mat-icon>refresh</mat-icon> Retry
          </button>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Product Purchase Summary Card -->
    <mat-card *ngIf="product" class="mb-6">
      <mat-card-header>
        <mat-card-title>Purchase Summary</mat-card-title>
      </mat-card-header>
      <mat-card-content class="mt-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="field-container" *ngIf="product.name">
            <div class="field-label">Product Name</div>
            <div class="field-value">{{ product.name }}</div>
          </div>
          <div class="field-container" *ngIf="product.price">
            <div class="field-label">Price</div>
            <div class="field-value">{{ product.price }} ETH</div>
          </div>
          <div class="field-container" *ngIf="productType">
            <div class="field-label">Product Type</div>
            <div class="field-value capitalize">{{ productType }}</div>
          </div>
          <div class="field-container" *ngIf="product.bambooHarvestId">
            <div class="field-label">Bamboo Source ID</div>
            <div class="field-value">{{ product.bambooHarvestId }}</div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Add a section for product information if available -->
    <div *ngIf="product" class="product-info">
      <h3>Product Information</h3>
      <p><strong>Type:</strong> {{ productType | titlecase }}</p>
      <p><strong>ID:</strong> {{ productId }}</p>
      <p><strong>Status:</strong> {{ product.status }}</p>

      <!-- Add manual update button for bamboo products -->
      <button
        *ngIf="productType?.toLowerCase().includes('bamboo')"
        mat-raised-button
        color="primary"
        (click)="forceUpdateBambooHarvestStatus()"
      >
        Update Bamboo Status
      </button>
    </div>

    <!-- Prominent QR Code Section -->
    <div class="qr-code-section mb-6">
      <mat-card class="qr-card">
        <mat-card-header>
          <div class="qr-header-content">
            <mat-card-title class="text-lg font-bold"
              >Transaction QR Code</mat-card-title
            >
            <mat-card-subtitle
              >Scan this QR code to view transaction details</mat-card-subtitle
            >
          </div>
        </mat-card-header>
        <mat-card-content class="qr-content">
          <div class="qr-wrapper">
            <div class="qrcode-container" id="qrcode-container"></div>
            <div class="qr-info mt-3">
              <p>This QR code links to the Etherscan transaction page</p>
            </div>
          </div>
        </mat-card-content>
        <mat-card-actions align="center" class="qr-actions">
          <button mat-raised-button color="primary" (click)="refreshQRCode()">
            <mat-icon>refresh</mat-icon> Refresh QR
          </button>
          <button mat-raised-button color="accent" (click)="downloadQRCode()">
            <mat-icon>download</mat-icon> Download QR
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- Action buttons section -->
    <div class="action-buttons-container">
      <div class="section-title">Actions</div>
      <div class="actions-grid">
        <button mat-flat-button color="primary" (click)="openDeliveryModal()">
          <mat-icon>visibility</mat-icon>
          View Product
        </button>

        <button mat-flat-button color="accent" (click)="forceStatusUpdate()">
          <mat-icon>refresh</mat-icon>
          Force Status Update
        </button>

        <!-- Special button for bamboo harvest fix -->
        <button
          *ngIf="
            productType &&
            ['bamboo', 'bambooharvest', 'bamboo-harvest'].includes(
              productType.toLowerCase()
            )
          "
          mat-flat-button
          color="warn"
          (click)="forceUpdateBambooHarvestStatus()"
          class="bamboo-fix-button"
        >
          <mat-icon>healing</mat-icon>
          Fix Bamboo Status
        </button>

        <!-- EMERGENCY Fix Button - only for bamboo harvests -->
        <button
          *ngIf="
            productType &&
            ['bamboo', 'bambooharvest', 'bamboo-harvest'].includes(
              productType.toLowerCase()
            ) &&
            product &&
            product.status !== 'SOLD'
          "
          mat-flat-button
          color="warn"
          (click)="emergencyBambooStatusUpdate()"
          class="emergency-fix-button"
          style="background-color: darkred; color: white; font-weight: bold"
        >
          <mat-icon>emergency</mat-icon>
          EMERGENCY FIX
        </button>

        <!-- XMLHttpRequest approach - another emergency option -->
        <button
          *ngIf="
            productType &&
            ['bamboo', 'bambooharvest', 'bamboo-harvest'].includes(
              productType.toLowerCase()
            ) &&
            product &&
            product.status !== 'SOLD'
          "
          mat-flat-button
          color="warn"
          (click)="tryXmlHttpRequest()"
          class="xml-http-button"
          style="background-color: #880000; color: white; font-weight: bold"
        >
          <mat-icon>code</mat-icon>
          XML HTTP FIX
        </button>

        <!-- Direct Fabric call - last resort -->
        <button
          *ngIf="
            productType &&
            ['bamboo', 'bambooharvest', 'bamboo-harvest'].includes(
              productType.toLowerCase()
            ) &&
            product &&
            product.status !== 'SOLD'
          "
          mat-flat-button
          color="warn"
          (click)="tryDirectFabricCall()"
          class="fabric-call-button"
          style="background-color: #550000; color: white; font-weight: bold"
        >
          <mat-icon>settings_ethernet</mat-icon>
          DIRECT FABRIC CALL
        </button>

        <!-- Special button for bamboo or bookshelf products -->
        <button
          *ngIf="
            productType &&
            ['bamboo', 'bambooharvest', 'bamboo-harvest', 'bookshelf'].includes(
              productType.toLowerCase()
            ) &&
            product &&
            product.status !== 'SOLD'
          "
          mat-flat-button
          color="warn"
          (click)="directUpdateProductStatus(true)"
        >
          <mat-icon>update</mat-icon>
          Direct Status Update
        </button>

        <button mat-flat-button color="primary" (click)="shareReceipt()">
          <mat-icon>share</mat-icon>
          Share Receipt
        </button>
      </div>
    </div>

    <!-- Debug section to show raw data - normally hidden but can be toggled -->
    <div class="mt-6">
      <button mat-button color="primary" (click)="debugMode = !debugMode">
        {{ debugMode ? "Hide" : "Show" }} Debug Info
      </button>

      <div
        *ngIf="debugMode"
        class="p-4 mt-2 bg-gray-100 rounded-lg border border-gray-300 overflow-auto"
      >
        <h3 class="text-lg font-semibold mb-2">Debug Information</h3>

        <div class="grid grid-cols-1 gap-4">
          <div>
            <h4 class="font-medium">Transaction Information:</h4>
            <div class="mb-4">
              <p><strong>Original Hash:</strong> {{ txHash }}</p>
              <p><strong>Used Hash:</strong> {{ actualTxHash || txHash }}</p>
              <p>
                <strong>Link:</strong>
                <a [href]="getEtherscanLink()" target="_blank"
                  >View on Etherscan</a
                >
              </p>
            </div>

            <div
              class="mt-4"
              *ngIf="paymentService.getRecentTransactionHashes().length > 0"
            >
              <h4 class="font-medium">Recent Transactions:</h4>
              <div class="grid grid-cols-1 gap-2 mt-2">
                <div
                  *ngFor="
                    let hash of paymentService.getRecentTransactionHashes()
                  "
                  class="bg-gray-100 p-2 rounded flex items-center justify-between"
                >
                  <span class="truncate">{{ hash }}</span>
                  <a
                    [href]="'https://sepolia.etherscan.io/tx/' + hash"
                    target="_blank"
                    class="text-blue-500 hover:underline ml-2"
                    >View</a
                  >
                </div>
              </div>
            </div>
          </div>

          <div>
            <h4 class="font-medium">Transaction Object:</h4>
            <pre
              class="bg-gray-800 text-green-400 p-2 rounded overflow-auto text-xs"
              >{{ transaction | json }}</pre
            >
          </div>

          <div>
            <h4 class="font-medium">Formatted Receipt:</h4>
            <pre
              class="bg-gray-800 text-green-400 p-2 rounded overflow-auto text-xs"
              >{{ receipt | json }}</pre
            >
          </div>

          <div *ngIf="rawTxData">
            <h4 class="font-medium">Raw Transaction Response:</h4>
            <pre
              class="bg-gray-800 text-green-400 p-2 rounded overflow-auto text-xs"
              >{{ rawTxData | json }}</pre
            >
          </div>

          <div *ngIf="rawReceiptData">
            <h4 class="font-medium">Raw Receipt Response:</h4>
            <pre
              class="bg-gray-800 text-green-400 p-2 rounded overflow-auto text-xs"
              >{{ rawReceiptData | json }}</pre
            >
          </div>

          <div *ngIf="rawBlockData">
            <h4 class="font-medium">Raw Block Response:</h4>
            <pre
              class="bg-gray-800 text-green-400 p-2 rounded overflow-auto text-xs"
              >{{ rawBlockData | json }}</pre
            >
          </div>

          <div>
            <h4 class="font-medium">Component State:</h4>
            <pre
              class="bg-gray-800 text-green-400 p-2 rounded overflow-auto text-xs"
            >
isLoading: {{ isLoading }}
loading: {{ loading }}
error: {{ error }}
apiKeyMessage: {{ apiKeyMessage }}
            </pre>
          </div>
        </div>

        <button
          mat-raised-button
          color="warn"
          class="mt-4"
          (click)="showRawData()"
        >
          Log Raw Data to Console
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delivery Progress Modal -->
<div class="delivery-modal" [class.show-modal]="showDeliveryModal">
  <div class="delivery-modal-content">
    <div class="modal-header">
      <h2>Delivery Status</h2>
      <button class="close-button" (click)="closeDeliveryModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="delivery-progress">
        <div class="progress-steps">
          <div class="progress-step" [class.active]="true">
            <div class="step-icon">
              <img
                src="assets/icons/pickup.svg"
                alt="Pick Up"
                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMTYgNGgyYTIgMiAwIDAgMSAyIDJ2MTRhMiAyIDAgMCAxLTIgMkg2YTIgMiAwIDAgMS0yLTJWNmEyIDIgMCAwIDEgMi0yaDIiPjwvcGF0aD48cGF0aCBkPSJNMTUgMmgtNmEyIDIgMCAwIDAtMiAydjE2YTIgMiAwIDAgMCAyIDJoNmEyIDIgMCAwIDAgMi0yVjRhMiAyIDAgMCAwLTItMnoiPjwvcGF0aD48cGF0aCBkPSJNMTAgMTRsNCAwIj48L3BhdGg+PHBhdGggZD0iTTEyIDEybDAgNCIgc3Ryb2tlPSIjZmZmZmZmIj48L3BhdGg+PC9zdmc+'"
              />
            </div>
            <div class="step-label">Pick Up</div>
          </div>
          <div class="step-connector"></div>
          <div class="progress-step" [class.active]="true">
            <div class="step-icon">
              <img
                src="assets/icons/process.svg"
                alt="On Process"
                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cmVjdCB4PSIxIiB5PSIzIiB3aWR0aD0iMTUiIGhlaWdodD0iMTMiPjwvcmVjdD48cG9seWdvbiBwb2ludHM9IjE2IDggMjAgMTIgMTYgMTYgMTYgOCI+PC9wb2x5Z29uPjwvc3ZnPg=='"
              />
            </div>
            <div class="step-label">On Process</div>
          </div>
          <div class="step-connector"></div>
          <div class="progress-step" [class.active]="true">
            <div class="step-icon">
              <img
                src="assets/icons/delivery.svg"
                alt="On Delivery"
                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNmZmZmZmYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48Y2lyY2xlIGN4PSI3IiBjeT0iMTciIHI9IjIiPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjE3IiBjeT0iMTciIHI9IjIiPjwvY2lyY2xlPjxwYXRoIGQ9Ik0xIDdoNHY0YTIgMiAwIDAgMSAtMiAyeiI+PC9wYXRoPjxwYXRoIGQ9Ik0zIDdoMTN2MTBIOXYtM2gtNnYzeiI+PC9wYXRoPjxwYXRoIGQ9Ik04IDhoOXYyIj48L3BhdGg+PC9zdmc+'"
              />
            </div>
            <div class="step-label">On Delivery</div>
          </div>
          <div class="step-connector"></div>
          <div class="progress-step">
            <div class="step-icon">
              <img
                src="assets/icons/delivered.svg"
                alt="Delivered"
                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNhYWFhYWEiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIj48cGF0aCBkPSJNMjAgMTZzLTIgMi00IDJjLTMgMS01LTEtNy0yLTMtMS00LTEtNCAxIj48L3BhdGg+PHBhdGggZD0iTTggMThMMyAxNHY2Ij48L3BhdGg+PHBhdGggZD0iTTMgMTR2LTVhNCw0LDAsMCwxLDQtNGgyYzIsMCwyLDQsNiw0aDJhMywzLDAsMCwxLDMsM3Y0Ij48L3BhdGg+PHBhdGggZD0iTTE4IDE3djUiPjwvcGF0aD48cGF0aCBkPSJNMTUgMjBsMyAyIDMtMiI+PC9wYXRoPjwvc3ZnPg=='"
              />
            </div>
            <div class="step-label">Delivered</div>
          </div>
        </div>
      </div>

      <div class="delivery-info">
        <div class="product-summary">
          <div class="summary-row">
            <span class="summary-label">Product:</span>
            <span class="summary-value"
              >{{ productType | titlecase }} #{{ productId }}</span
            >
          </div>
          <div class="summary-row">
            <span class="summary-label">Status:</span>
            <span
              class="summary-value status-badge"
              [ngClass]="{
                'status-sold': product?.status === 'SOLD',
                'status-shipped': product?.status === 'SHIPPED',
                'status-processing': product?.status === 'PROCESSING'
              }"
              >{{ product?.status || "PROCESSING" }}</span
            >
          </div>
          <div class="summary-row" *ngIf="transaction?.timestamp">
            <span class="summary-label">Estimated Delivery:</span>
            <span class="summary-value">{{
              getEstimatedDeliveryDate() | date: "medium"
            }}</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button mat-flat-button color="primary" (click)="closeDeliveryModal()">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Fallback QR Code library -->
<script>
  // Check if QR code library is already loaded
  if (typeof QRCode === "undefined") {
    console.log("Loading QR code library...");
    // Create script element to load the library
    const script = document.createElement("script");
    script.src =
      "https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js";
    script.async = true;
    script.onload = function () {
      console.log("QR code library loaded successfully");
      // Trigger QR code generation once loaded
      setTimeout(function () {
        // Try to find and click refresh buttons to generate QR codes
        const refreshBtn = document.querySelector(
          'button[mat-raised-button][color="primary"]',
        );
        if (refreshBtn) {
          refreshBtn.click();
        }
      }, 500);
    };
    script.onerror = function () {
      console.error("Failed to load QR code library");
    };
    document.body.appendChild(script);
  }
</script>

<style>
  .field-container {
    margin-bottom: 16px;
  }
  .field-label {
    font-size: 14px;
    color: #666;
    margin-bottom: 4px;
  }
  .field-value {
    font-size: 16px;
    word-break: break-all;
  }
  .overflow-ellipsis {
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .field-value-with-copy {
    display: flex;
    align-items: center;
  }
  .status-indicator {
    padding: 4px 8px;
    border-radius: 4px;
    background-color: #f0f0f0;
  }
  .success-message {
    background-color: rgba(0, 128, 0, 0.1);
    border-radius: 8px;
  }
  .copy-button {
    margin-left: 8px;
  }
  .status-badge {
    display: flex;
    align-items: center;
    padding: 4px 8px;
    border-radius: 4px;
    background-color: #f0f0f0;
  }
  /* Ensure badges and status text are properly displayed */
  .badge,
  .status {
    padding: 4px 8px;
    border-radius: 16px;
    font-size: 12px;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
  }

  /* Fix "co nfo" display issue */
  .copy-info {
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
  }

  .copy-info mat-icon {
    margin-right: 4px;
  }

  /* Fix button text overflow */
  button mat-icon + span {
    white-space: nowrap;
  }

  /* Ensure step content is fully visible */
  .step-content {
    width: 100%;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px;
  }

  .step-content p {
    margin: 8px 0 0 0;
    text-align: center;
    font-size: 14px;
    line-height: 1.4;
    width: 100%;
    word-wrap: break-word;
    white-space: normal;
  }

  /* Force visible full text in stepper */
  ::ng-deep .mat-horizontal-stepper-header {
    height: auto !important;
    padding: 12px !important;
  }

  ::ng-deep .mat-step-label {
    white-space: normal !important;
    overflow: visible !important;
    display: block !important;
    width: 100% !important;
    text-align: center !important;
    color: rgba(0, 0, 0, 0.87) !important;
  }

  ::ng-deep .mat-step-text-label {
    text-overflow: clip !important;
    overflow: visible !important;
    white-space: normal !important;
    display: block !important;
    width: 100% !important;
  }

  /* Fix step content that's showing only first letter */
  ::ng-deep .step-content {
    display: block !important;
    width: 100% !important;
    text-align: center !important;
    min-height: 60px !important;
  }

  ::ng-deep .step-content p {
    display: block !important;
    width: 100% !important;
    margin: 8px 0 0 0 !important;
    text-align: center !important;
    color: rgba(0, 0, 0, 0.87) !important;
    line-height: 1.4 !important;
    white-space: normal !important;
  }

  /* Fix for "co nfo" text */
  ::ng-deep .copy-text,
  ::ng-deep .status-badge,
  ::ng-deep .copy-info {
    display: inline-flex !important;
    align-items: center !important;
    white-space: nowrap !important;
    padding: 4px 8px !important;
    background-color: #f0f0f0 !important;
    border-radius: 4px !important;
    color: #333333 !important;
  }

  /* Ensure text after icon is visible */
  ::ng-deep button mat-icon + span,
  ::ng-deep .mat-icon + span {
    white-space: nowrap !important;
    overflow: visible !important;
    color: inherit !important;
  }

  /* Force light theme for all content */
  :host {
    color: #000000 !important;
    background-color: #ffffff !important;
  }

  ::ng-deep .mat-card {
    background-color: #ffffff !important;
    color: rgba(0, 0, 0, 0.87) !important;
  }

  /* Remove weird "ch" text at top */
  ::ng-deep .stepper-container::before,
  ::ng-deep .transaction-receipt::before,
  ::ng-deep .mat-card::before {
    content: none !important;
    display: none !important;
  }

  /* Dark theme styles */
  .dark-theme {
    color: #ffffff;
    background-color: #121212;
  }

  .dark-card {
    background-color: #1e1e1e !important;
    color: #ffffff !important;
  }

  .text-white {
    color: #ffffff !important;
  }

  /* Custom stepper styles */
  .custom-stepper {
    display: flex;
    flex-direction: column;
    padding: 16px 0;
  }

  .custom-step {
    margin-bottom: 24px;
  }

  .step-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
  }

  .step-icon-container {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #424242;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 12px;
  }

  .step-icon-container.completed {
    background-color: #4caf50;
  }

  .step-icon-container mat-icon {
    font-size: 18px;
    color: white;
  }

  .step-label {
    font-size: 16px;
    font-weight: 500;
    color: #ffffff;
  }

  .step-content {
    padding-left: 44px;
    margin-bottom: 16px;
  }

  .step-content p {
    margin: 0;
    color: #bbbbbb;
  }

  /* Make sure copy buttons display correctly */
  .copy-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  .copy-button mat-icon {
    color: #bbbbbb;
  }

  /* Status styling */
  .status-badge {
    background-color: #333333;
    color: white;
    padding: 4px 8px;
    border-radius: 16px;
    display: inline-flex;
    align-items: center;
  }

  .status-badge mat-icon {
    margin-right: 4px;
  }

  /* Force black backgrounds for step icons */
  .step-icon-container {
    background-color: #000000 !important;
  }

  .step-icon-container.completed {
    background-color: #000000 !important;
    color: #ffffff !important;
  }

  /* Override any other styles that might change the background */
  .mat-step-icon,
  .mat-step-icon-selected,
  .mat-step-icon-completed {
    background-color: #000000 !important;
  }

  /* Make sure white icons are visible on black */
  .step-icon-container mat-icon {
    color: inherit !important;
  }

  /* Style for the special bamboo fix button */
  .bamboo-fix-button {
    background-color: #8bc34a !important; /* Light green */
    color: #fff !important;
    font-weight: bold !important;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
    animation: pulse 1.5s infinite;
  }

  @keyframes pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(139, 195, 74, 0.7);
    }
    70% {
      box-shadow: 0 0 0 10px rgba(139, 195, 74, 0);
    }
    100% {
      box-shadow: 0 0 0 0 rgba(139, 195, 74, 0);
    }
  }

  /* Fix for certain text display issues */
  button mat-icon {
    margin-right: 4px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }

  /* QR Code Styles */
  .qrcode-container {
    width: 250px;
    height: 250px;
    margin: 0 auto;
    padding: 10px;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .qr-canvas {
    display: block;
    width: 100%;
    height: 100%;
  }

  /* Action buttons container */
  .action-buttons-container {
    margin-bottom: 24px;
  }

  .section-title {
    font-size: 18px;
    font-weight: 500;
    margin-bottom: 16px;
    color: #ffffff;
  }

  .actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 12px;
  }

  /* QR Code Styling */
  .qr-code-section {
    margin-top: 20px;
  }

  .qr-card {
    border: none;
    border-radius: 12px;
    background-color: #2d2d2d !important;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    overflow: hidden;
  }

  .qr-header-content {
    width: 100%;
    text-align: center;
    padding: 16px 0;
  }

  .qr-content {
    display: flex;
    justify-content: center;
    padding: 24px 0;
  }

  .qr-wrapper {
    text-align: center;
  }

  .qrcode-container {
    width: 250px;
    height: 250px;
    margin: 0 auto;
    padding: 15px;
    background-color: white;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
  }

  .qrcode-container::before {
    content: "";
    position: absolute;
    top: -10px;
    left: -10px;
    right: -10px;
    bottom: -10px;
    background: linear-gradient(45deg, #4caf50, #3f51b5, #2196f3, #00bcd4);
    background-size: 400% 400%;
    z-index: -1;
    border-radius: 18px;
    animation: gradient 6s ease infinite;
  }

  @keyframes gradient {
    0% {
      background-position: 0% 50%;
    }
    50% {
      background-position: 100% 50%;
    }
    100% {
      background-position: 0% 50%;
    }
  }

  .qr-info {
    margin-top: 16px;
    color: #aaaaaa;
    font-size: 14px;
  }

  .qr-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    padding: 0 16px 24px;
  }

  .qr-actions button {
    padding: 0 24px;
  }

  /* Modal base styles */
  .delivery-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    overflow: auto;
    justify-content: center;
    align-items: center;
    transition: opacity 0.3s ease;
    opacity: 0;
  }

  .show-modal {
    display: flex;
    opacity: 1;
  }

  .delivery-modal-content {
    background-color: #1e1e1e;
    border-radius: 12px;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
    margin: 20px;
    overflow: hidden;
    animation: modal-in 0.3s ease;
  }

  @keyframes modal-in {
    from {
      transform: scale(0.95);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background-color: #0066cc;
    color: white;
  }

  .modal-header h2 {
    margin: 0;
    font-size: 20px;
  }

  .close-button {
    background: none;
    border: none;
    font-size: 24px;
    color: white;
    cursor: pointer;
    padding: 0;
    line-height: 24px;
  }

  .modal-body {
    padding: 24px;
    color: #ffffff;
  }

  .modal-footer {
    padding: 16px 20px;
    display: flex;
    justify-content: flex-end;
    border-top: 1px solid #333333;
  }

  /* Delivery progress styles */
  .delivery-progress {
    margin-bottom: 30px;
  }

  .progress-steps {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 0 -10px;
  }

  .progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0 10px;
    flex: 1;
    z-index: 1;
  }

  .step-icon {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background-color: #333333;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 8px;
    border: 3px solid #333333;
    position: relative;
    transition: all 0.3s ease;
  }

  .step-icon img {
    width: 30px;
    height: 30px;
  }

  .progress-step.active .step-icon {
    background-color: #0066cc;
    border-color: #0099ff;
    box-shadow: 0 0 15px rgba(0, 153, 255, 0.5);
  }

  .step-label {
    font-size: 14px;
    font-weight: 500;
    text-align: center;
    color: #aaaaaa;
    transition: color 0.3s ease;
  }

  .progress-step.active .step-label {
    color: #ffffff;
    font-weight: 600;
  }

  .step-connector {
    flex: 1;
    height: 4px;
    background-color: #333333;
    position: relative;
    margin: 0 -10px;
    top: -30px;
    z-index: 0;
  }

  .progress-step.active + .step-connector {
    background-color: #0066cc;
  }

  /* Delivery info styles */
  .delivery-info {
    margin-top: 20px;
    background-color: #272727;
    padding: 20px;
    border-radius: 8px;
  }

  .product-summary {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .summary-row {
    display: flex;
    align-items: center;
  }

  .summary-label {
    min-width: 150px;
    color: #bbbbbb;
    font-weight: 500;
    font-size: 14px;
  }

  .summary-value {
    color: #ffffff;
    font-size: 14px;
  }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
  }

  .status-sold {
    background-color: #4caf50;
    color: white;
  }

  .status-shipped {
    background-color: #2196f3;
    color: white;
  }

  .status-processing {
    background-color: #ff9800;
    color: white;
  }
</style>
